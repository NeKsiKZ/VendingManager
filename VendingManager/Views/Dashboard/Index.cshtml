@model VendingManager.ViewModels.DashboardViewModel
@using System.Globalization

@{
	ViewData["Title"] = "Dashboard";
}

<style>
	.signalr-toast {
		position: fixed;
		top: 20px;
		right: 20px;
		padding: 15px 20px;
		border-radius: 12px;
		color: #fff;
		font-weight: 500;
		font-size: 1rem;
		z-index: 1050;
		opacity: 0;
		transform: translateY(-20px);
		transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
		box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
	}

		.signalr-toast.show {
			opacity: 1;
			transform: translateY(0);
		}

	.toast-success {
		background: linear-gradient(135deg, #10b981 0%, #059669 100%);
	}

	.toast-error {
		background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
	}

	#dashboardMap {
		height: 450px;
		width: 100%;
		border-radius: 0.5rem;
	}
</style>

<div class="container-fluid py-4">

	<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
		<div>
			<h1 class="display-5 fw-bold text-primary mb-0">Dashboard</h1>
			<p class="text-muted">Przegląd stanu automatów w czasie rzeczywistym.</p>
		</div>
		<div class="mt-3 mt-md-0">
			<span class="badge bg-light text-dark border px-3 py-2">
				Ostatnia aktualizacja: @DateTime.Now.ToString("HH:mm")
			</span>
		</div>
	</div>

	<div class="card shadow-sm border-0 mb-4">
		<div class="card-body bg-light rounded-3">
			<form method="get" asp-controller="Dashboard" asp-action="Index" class="row g-3 align-items-end">
				<div class="col-12 col-md-4 col-lg-3">
					<label asp-for="StartDate" class="form-label fw-bold text-muted small">OD DATY</label>
					<input asp-for="StartDate" class="form-control shadow-none" type="date" value="@Model.StartDate.ToString("yyyy-MM-dd")" />
				</div>
				<div class="col-12 col-md-4 col-lg-3">
					<label asp-for="EndDate" class="form-label fw-bold text-muted small">DO DATY</label>
					<input asp-for="EndDate" class="form-control shadow-none" type="date" value="@Model.EndDate.ToString("yyyy-MM-dd")" />
				</div>
				<div class="col-12 col-md-4 col-lg-2">
					<button type="submit" class="btn btn-primary w-100 shadow-sm">
						<i class="bi bi-filter"></i> Filtruj
					</button>
				</div>
			</form>
		</div>
	</div>

	<div class="row g-4 mb-4">
		<div class="col-12 col-md-4">
			<div class="card border-0 shadow-sm h-100 overflow-hidden">
				<div class="card-body position-relative">
					<div class="position-absolute top-0 end-0 p-3 opacity-10">
						<i class="bi bi-cash-coin display-1 text-success"></i>
					</div>
					<h6 class="text-uppercase text-muted fw-bold ls-1">Przychód</h6>
					<h2 class="display-6 fw-bold text-success mb-0">
						@Model.TotalRevenue.ToString("C", new CultureInfo("pl-PL"))
					</h2>
					<p class="small text-muted mt-2 mb-0">w wybranym okresie</p>
				</div>
				<div class="card-footer bg-success bg-opacity-10 border-0 py-2">
					<small class="text-success fw-bold"><i class="bi bi-graph-up"></i> +12% vs poprzedni okres</small>
				</div>
			</div>
		</div>

		<div class="col-12 col-md-4">
			<div class="card border-0 shadow-sm h-100 overflow-hidden">
				<div class="card-body position-relative">
					<div class="position-absolute top-0 end-0 p-3 opacity-10">
						<i class="bi bi-trophy display-1 text-warning"></i>
					</div>
					<h6 class="text-uppercase text-muted fw-bold ls-1">Bestseller</h6>
					<h2 class="display-6 fw-bold text-dark mb-0 text-truncate" title="@Model.BestSellingProduct">
						@(string.IsNullOrEmpty(Model.BestSellingProduct) ? "-" : Model.BestSellingProduct)
					</h2>
					<p class="small text-muted mt-2 mb-0">
						Sprzedano: <strong>@Model.BestSellingProductCount</strong> szt.
					</p>
				</div>
				<div class="card-footer bg-warning bg-opacity-10 border-0 py-2">
					<small class="text-warning fw-bold text-dark"><i class="bi bi-star-fill"></i> Top Produkt</small>
				</div>
			</div>
		</div>

		<div class="col-12 col-md-4">
			<div class="card border-0 shadow-sm h-100 overflow-hidden">
				<div class="card-body position-relative">
					<div class="position-absolute top-0 end-0 p-3 opacity-10">
						<i class="bi bi-receipt display-1 text-info"></i>
					</div>
					<h6 class="text-uppercase text-muted fw-bold ls-1">Transakcje</h6>
					<h2 class="display-6 fw-bold text-info mb-0">
						@Model.TotalTransactions
					</h2>
					<p class="small text-muted mt-2 mb-0">liczba sprzedaży</p>
				</div>
				<div class="card-footer bg-info bg-opacity-10 border-0 py-2">
					<small class="text-info fw-bold"><i class="bi bi-activity"></i> Aktywność sytemu</small>
				</div>
			</div>
		</div>
	</div>

	<div class="row g-4 mb-4">
		<div class="col-12 col-xl-8">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-header bg-white border-0 py-3">
					<h5 class="card-title mb-0 fw-bold">Analiza Sprzedaży</h5>
				</div>
				<div class="card-body">
					<div style="position: relative; height: 300px; width: 100%">
						<canvas id="monthlyRevenueChart"></canvas>
					</div>
				</div>
			</div>
		</div>

		<div class="col-12 col-xl-4">
			<div class="card border-0 shadow-sm h-100">
				<div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
					<h5 class="card-title mb-0 fw-bold">Stan Maszyn</h5>
					<span class="badge bg-primary rounded-pill">@Model.MachineStatuses.Count</span>
				</div>

				<div class="table-responsive">
					<table class="table table-hover align-middle mb-0" style="table-layout: fixed; width: 100%;">
						<thead class="table-light">
							<tr>
								<th class="ps-4" style="width: 45%;">Maszyna</th>
								<th style="width: 30%;">Zapełnienie</th>
								<th class="text-end pe-4" style="width: 25%;">Status</th>
							</tr>
						</thead>
						<tbody>
							@if (Model.MachineStatuses.Any())
							{
								@foreach (var machine in Model.MachineStatuses.Take(3))
								{
									<tr>
										<td class="ps-4" style="word-wrap: break-word; white-space: normal;">
											<div class="fw-bold text-dark">@machine.Name</div>
											<small class="text-muted"><i class="bi bi-geo-alt"></i> @machine.Location</small>
										</td>
										<td style="word-wrap: break-word; white-space: normal;">
											@{
												string barColor = "bg-success";
												if (machine.FillPercentage < 40) barColor = "bg-warning";
												if (machine.FillPercentage < 15) barColor = "bg-danger";
											}
											<div class="d-flex align-items-center">
												<span class="me-2 small fw-bold">@machine.FillPercentage%</span>
												<div class="progress flex-grow-1" style="height: 6px;">
													<div class="progress-bar @barColor" role="progressbar" style="width: @machine.FillPercentage%"></div>
												</div>
											</div>
										</td>
										<td class="text-end pe-4">
											@if (machine.Status == "Online")
											{
												<span class="badge bg-success bg-opacity-10 text-success px-2 py-1 rounded-pill">Online</span>
											}
											else
											{
												<span class="badge bg-danger bg-opacity-10 text-danger px-2 py-1 rounded-pill">Offline</span>
											}
										</td>
									</tr>
								}
								<tr>
									<td colspan="3" class="text-center py-3 border-0">
										<a asp-controller="Machines" asp-action="Index" class="btn btn-sm btn-outline-primary rounded-pill px-4">
											Zobacz wszystkie automaty
										</a>
									</td>
								</tr>
							}
							else
							{
								<tr><td colspan="3" class="text-center py-4 text-muted">Brak danych</td></tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<div class="card border-0 shadow-sm">
		<div class="card-body p-2">
			<div id="dashboardMap"></div>
		</div>
	</div>

	@section Scripts {
		@{
			var mapData = Model.MachineStatuses.Select(m => new
			{
				id = m.Id,
				name = m.Name,
				location = m.Location,
				lat = m.Latitude,
				lon = m.Longitude,
				markerColor = m.MarkerColor
			}).ToList();
			var machinesJson = Html.Raw(Json.Serialize(mapData));

			var chartLabels = Html.Raw(Json.Serialize(Model.ChartLabels));
			var chartData = Html.Raw(Json.Serialize(Model.ChartData));
		}

		<script>
			document.addEventListener("DOMContentLoaded", function () {

				var baseIcon = L.Icon.extend({
					options: {
						shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
						iconSize: [25, 41],
						iconAnchor: [12, 41],
						popupAnchor: [1, -34],
						shadowSize: [41, 41]
					}
				});

				var greenIcon = new baseIcon({ iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-green.png' });
				var redIcon = new baseIcon({ iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-red.png' });
				var orangeIcon = new baseIcon({ iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-orange.png' });
				var greyIcon = new baseIcon({ iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-grey.png' });

				var map = L.map('dashboardMap').setView([53.1325, 23.1688], 13);

				L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
					attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
				}).addTo(map);

				var machines = @machinesJson;

				machines.forEach(function (machine) {
					if (machine.lat !== 0 && machine.lon !== 0) {
						let currentIcon = greenIcon;
						if (machine.markerColor === 'red') currentIcon = redIcon;
						if (machine.markerColor === 'orange') currentIcon = orangeIcon;
						if (machine.markerColor === 'grey') currentIcon = greyIcon;

						L.marker([machine.lat, machine.lon], { icon: currentIcon })
							.addTo(map)
							.bindPopup(`<div style="text-align:center;"><strong>${machine.name}</strong><br><span class="text-muted">${machine.location}</span></div>`);
					}
				});

				const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');

				let gradient = ctx.createLinearGradient(0, 0, 0, 400);
				gradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
				gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

				new Chart(ctx, {
					type: 'line',
					data: {
						labels: @chartLabels,
						datasets: [{
							label: 'Przychód (PLN)',
							data: @chartData,
							backgroundColor: gradient,
							borderColor: '#10b981',
							borderWidth: 3,
							pointBackgroundColor: '#ffffff',
							pointBorderColor: '#10b981',
							pointBorderWidth: 3,
							pointRadius: 6,
							pointHoverRadius: 8,
							fill: true,
							tension: 0.4
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: {
							legend: { display: false },
							tooltip: {
								backgroundColor: 'rgba(0,0,0,0.8)',
								padding: 12,
								cornerRadius: 8,
								displayColors: false
							}
						},
						scales: {
							y: {
								beginAtZero: true,
								grid: { borderDash: [5, 5], color: '#f0f0f0' },
								ticks: {
									callback: function (value) { return value + ' zł'; },
									font: { family: "'Inter', sans-serif", size: 11 }
								}
							},
							x: {
								grid: { display: false },
								ticks: { font: { family: "'Inter', sans-serif", size: 11 } }
							}
						}
					}
				});

				const connection = new signalR.HubConnectionBuilder()
					.withUrl("/dashboardHub")
					.withAutomaticReconnect()
					.build();

				connection.on("ReceiveSaleNotification", (machineId, productName) => {
					showToast(`Sprzedano <b>${productName}</b> (Automat #${machineId})`, 'success');
				});

				connection.on("ReceiveErrorNotification", (machineId, errorCode) => {
					showToast(`AWARIA (Automat #${machineId}): Kod ${errorCode}`, 'error');
				});

				async function startSignalR() {
					try {
						await connection.start();
						console.log("SignalR Połączony.");
					} catch (err) {
						console.error(err);
						setTimeout(startSignalR, 5000);
					}
				};

				function showToast(message, type = 'success') {
					let toast = document.createElement('div');
					toast.className = `signalr-toast ${type === 'error' ? 'toast-error' : 'toast-success'}`;
					toast.innerHTML = message;

					document.body.appendChild(toast);

					requestAnimationFrame(() => {
						toast.classList.add('show');
					});

					setTimeout(() => {
						toast.classList.remove('show');
						setTimeout(() => {
							if (document.body.contains(toast)) {
								document.body.removeChild(toast);
							}
						}, 500);
					}, 5000);
				}

				startSignalR();
			});
		</script>
	}
</div>