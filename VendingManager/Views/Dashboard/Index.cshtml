@model VendingManager.ViewModels.DashboardViewModel
@using System.Globalization

@{
	ViewData["Title"] = "Dashboard";
}

<style>
	.signalr-toast {
		position: fixed;
		top: 20px;
		right: 20px;
		padding: 15px 20px;
		border-radius: 8px;
		color: #fff;
		font-size: 1.1em;
		z-index: 1050;
		opacity: 0;
		transform: translateX(100%);
		transition: all 0.5s ease;
	}

		.signalr-toast.show {
			opacity: 1;
			transform: translateX(0);
		}

	.toast-success {
		background-color: #198754;
	}

	.toast-error {
		background-color: #dc3545;
	}

	#dashboardMap {
		height: 400px;
		width: 100%;
		border-radius: 8px;
		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	}
</style>

<div class="text-center">

	<div class="text-center">
		<h1 class="display-4">Dashboard Automatów</h1>
	</div>

	<div class="row justify-content-center mb-3">
		<div class="col-md-8">
			<div class="card shadow-sm">
				<div class="card-body">
					<form method="get" asp-controller="Dashboard" asp-action="Index" class="row g-3 align-items-end">
						<div class="col">
							<label asp-for="StartDate" class="form-label"></label>
							<input asp-for="StartDate" class="form-control" type="date" value="@Model.StartDate.ToString("yyyy-MM-dd")" />
						</div>
						<div class="col">
							<label asp-for="EndDate" class="form-label"></label>
							<input asp-for="EndDate" class="form-control" type="date" value="@Model.EndDate.ToString("yyyy-MM-dd")" />
						</div>
						<div class="col-auto">
							<button type="submit" class="btn btn-primary">Filtruj</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<hr />

	<div class="row mb-3 g-3">
		<div class="col-md-4">
			<div class="card text-white bg-success shadow">
				<div class="card-body">
					<h5 class="card-title">@Html.DisplayNameFor(m => m.TotalRevenue)</h5>
					<h2 class="card-text">@Model.TotalRevenue.ToString("C", new CultureInfo("pl-PL"))</h2>
					<p class="card-text"><small>w wybranym okresie</small></p>
				</div>
			</div>
		</div>

		<div class="col-md-4">
			<div class="card shadow">
				<div class="card-body">
					<h5 class="card-title">@Html.DisplayNameFor(m => m.BestSellingProduct)</h5>
					<h2 class="card-text">@Model.BestSellingProduct</h2>
					<p class="card-text"><small>Sprzedano @Model.BestSellingProductCount szt.</small></p>
				</div>
			</div>
		</div>

		<div class="col-md-4">
			<div class="card shadow">
				<div class="card-body">
					<h5 class="card-title">@Html.DisplayNameFor(m => m.TotalTransactions)</h5>
					<h2 class="card-text">@Model.TotalTransactions</h2>
					<p class="card-text"><small>w wybranym okresie</small></p>
				</div>
			</div>
		</div>
	</div>

	<div class="row mb-3">
		<div class="col">
			<div class="card shadow-sm">
				<div class="card-body">
					<h5 class="card-title">Przychód miesięczny</h5>

					<div style="position: relative; height: 250px;">
						<canvas id="monthlyRevenueChart"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>

	<h3>Lista Maszyn (@Model.MachineStatuses.Count szt.)</h3>
	<table class="table table-striped table-hover">
		<thead>
			<tr>
				<th>ID</th>
				<th>Nazwa</th>
				<th>Lokalizacja</th>
				<th>Zapełnienie</th>
				<th>Status</th>
				<th>Ostatni Kontakt</th>
			</tr>
		</thead>

		<tbody>
			@if (Model.MachineStatuses.Any())
			{
				@foreach (var machine in Model.MachineStatuses)
				{
					<tr>
						<td>@machine.Id</td>
						<td><strong>@machine.Name</strong></td>
						<td>@machine.Location</td>

						<td>
							@{
								string progressBarColor = "bg-success";
								if (machine.FillPercentage < 50) progressBarColor = "bg-warning";
								if (machine.IsStockLow) progressBarColor = "bg-danger";
							}

							<div class="progress" style="height: 25px;">
								<div class="progress-bar @progressBarColor"
									 role="progressbar"
									 style="width: @machine.FillPercentage%;"
									 aria-valuenow="@machine.FillPercentage"
									 aria-valuemin="0"
									 aria-valuemax="100">
									<strong>@machine.FillPercentage%</strong>
								</div>
							</div>
						</td>

						@if (machine.Status == "Online")
						{
							<td class="text-success">@machine.Status</td>
						}
						else
						{
							<td class="text-danger">@machine.Status</td>
						}

						<td>@machine.LastContact.ToString("yyyy-MM-dd HH:mm")</td>
					</tr>
				}
			}
			else
			{
				<tr>
					<td colspan="6" class="text-center text-muted">Brak maszyn w systemie.</td>
				</tr>
			}
		</tbody>

	</table>

	<div class="row mb-3">
		<div class="col">
			<div id="dashboardMap"></div>
		</div>
	</div>

	@section Scripts {
		@{
			var mapData = Model.MachineStatuses.Select(m => new
			{
				id = m.Id,
				name = m.Name,
				location = m.Location,
				lat = m.Latitude,
				lon = m.Longitude,
				markerColor = m.MarkerColor
			}).ToList();
			var machinesJson = Html.Raw(Json.Serialize(mapData));

			var chartLabels = Html.Raw(Json.Serialize(Model.ChartLabels));
			var chartData = Html.Raw(Json.Serialize(Model.ChartData));
		}

		<script>
			document.addEventListener("DOMContentLoaded", function () {

				var baseIcon = L.Icon.extend({
					options: {
						shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
						iconSize: [25, 41],
						iconAnchor: [12, 41],
						popupAnchor: [1, -34],
						shadowSize: [41, 41]
					}
				});

				var greenIcon = new baseIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png' });
				var redIcon = new baseIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png' });
				var orangeIcon = new baseIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png' });
				var greyIcon = new baseIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png' });

				var map = L.map('dashboardMap').setView([53.1325, 23.1688], 13);

				L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(map);

				var machines = @machinesJson;

				machines.forEach(function (machine) {
					if (machine.lat !== 0 && machine.lon !== 0) {

						let currentIcon;
						switch (machine.markerColor) {
							case "red":
								currentIcon = redIcon;
								break;
							case "orange":
								currentIcon = orangeIcon;
								break;
							case "grey":
								currentIcon = greyIcon;
								break;
							default:
								currentIcon = greenIcon;
						}

						L.marker([machine.lat, machine.lon], { icon: currentIcon })
							.addTo(map)
							.bindPopup(`<strong>${machine.name}</strong><br>${machine.location}`);
					}
				});

				const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');
				new Chart(ctx, {
					type: 'bar',
					data: {
						labels: @chartLabels,
						datasets: [{
							label: 'Przychód (PLN)',
							data: @chartData,
							backgroundColor: 'rgba(0, 123, 255, 0.5)',
							borderColor: 'rgba(0, 123, 255, 1)',
							borderWidth: 1
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							y: {
								beginAtZero: true,
								ticks: {
									callback: function (value, index, values) {
										return value + ' zł';
									}
								}
							}
						}
					}
				});

				const connection = new signalR.HubConnectionBuilder()
					.withUrl("/dashboardHub")
					.build();

				connection.on("ReceiveSaleNotification", (machineId, productName) => {
					showToast(`Nowa sprzedaż (Maszyna ${machineId}): Sprzedano ${productName}!`, 'success');
				});

				connection.on("ReceiveErrorNotification", (machineId, errorCode) => {
					showToast(`NOWY BŁĄD (Maszyna ${machineId}): ${errorCode}`, 'error');
				});

				async function startSignalR() {
					try {
						await connection.start();
						console.log("SignalR Połączony.");
					} catch (err) {
						console.error(err);
						setTimeout(startSignalR, 5000);
					}
				};

				function showToast(message, type = 'success') {
					let toast = document.createElement('div');
					toast.className = `signalr-toast ${type === 'error' ? 'toast-error' : 'toast-success'}`;
					toast.innerHTML = message;

					document.body.appendChild(toast);

					setTimeout(() => {
						toast.classList.add('show');
					}, 100);

					setTimeout(() => {
						toast.classList.remove('show');
						setTimeout(() => {
							if (document.body.contains(toast)) {
								document.body.removeChild(toast);
							}
						}, 500);
					}, 5000);
				}

				startSignalR();
			});
		</script>
	}
